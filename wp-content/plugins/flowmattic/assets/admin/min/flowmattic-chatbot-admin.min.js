jQuery(document).ready(function(a){"use strict";function b(a){var b=0,c=0,d=0;4==a.length?(b=parseInt(a[1]+a[1],16),c=parseInt(a[2]+a[2],16),d=parseInt(a[3]+a[3],16)):7==a.length&&(b=parseInt(a.substring(1,3),16),c=parseInt(a.substring(3,5),16),d=parseInt(a.substring(5,7),16)),b/=255,c/=255,d/=255;const e=Math.max(b,c,d),f=Math.min(b,c,d);var g,h,i=(e+f)/2;if(e==f)g=h=0;else{const j=e-f;switch(h=i>.5?j/(2-e-f):j/(e+f),e){case b:g=(c-d)/j+(c<d?6:0);break;case c:g=(d-b)/j+2;break;case d:g=(b-c)/j+4}g/=6}return h*=100,h=Math.round(h),i*=100,i=Math.round(i),"hsl("+(g=Math.round(360*g))+", "+h+"%, 95%)"}function c(a){var b=document.getElementById("chatbot_model_connect").value,c={action:"flowmattic_chatbot_refresh_assistants",connect_id:b,workflow_nonce:FMConfig.workflow_nonce};if(!b)return void g.fire({title:"Connect is required!",text:"Please choose a Connect to use with your assistant.",icon:"warning",showConfirmButton:!0});jQuery.ajax({url:ajaxurl,type:"POST",data:c,success:function(b){var c=JSON.parse(b),d="";if("success"===c.status){for(var e=c.assistants,f="",g="",h=0;h<e.length;h++)void 0!==a&&a===e[h].id?(g="selected",d=e[h].model,jQuery("#chatbot_instructions").val()!==e[h].instructions&&jQuery("#chatbot_instructions").val(e[h].instructions).trigger("change")):g="",f+="<option "+g+' value="'+e[h].id+'" data-subtext="ID: '+e[h].id+'">'+e[h].name+"</option>";jQuery("#chatbot_assistant").html(f),jQuery("#chatbot_assistant").selectpicker("refresh"),void 0!==a&&jQuery("#chatbot_assistant").selectpicker("val",a),jQuery("#chatbot_model").selectpicker("val",d),jQuery("#chatbot_model").selectpicker("refresh")}}})}function d(){var a={action:"get_threads",settings:{chatbotID:document.getElementById("fm_chatbot_id").value},chatbot_nonce:FMConfig.chatbot_nonce,userId:document.getElementById("fm_user_id").value,secureKey:document.getElementById("fm_secure_key").value};jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:a,success:function(a){var b=a,c=document.querySelector(".conversation-wrapper");if(c.innerHTML="","success"===b.status){var d=b.threads;jQuery.each(d,function(a,b){var d=JSON.parse(b.thread_data),e=new Date(b.thread_time).toLocaleString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric",hour12:!0}),f='<div class="conversation-item" data-thread-id="'+b.thread_id+'"><div class="conversation-item-header btn btn-outline-secondary d-flex align-items-center justify-content-between py-2"><div class="conversation-item-name">'+d.title+'</div><div class="conversation-item-date fw-lighter">'+e+"</div></div></div>";c.innerHTML+=f,0===a&&jQuery(".conversation-item").first().find(".btn").click()})}}})}function e(a){jQuery(".flowmattic-chatbot-message-holder").append(a)}function f(a){return a=a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),a.split("\n").filter(function(a){return a.trim()}).map(function(a,b,c){return a.trim().startsWith("<!-")?"&lt;"+a.trim().substring(1):a.trim().startsWith("<script")||a.trim().startsWith("<meta")||a.trim().startsWith("<title")||a.trim().startsWith("<link")?"<p>&lt;"+a.trim().substring(1)+"</p>"+(b<c.length-1?"\n":""):a.trim().startsWith("<")?a:"<p>"+a+"</p>"+(b<c.length-1?"\n":"")}).join("")}var g=window.Swal.mixin({customClass:{confirmButton:"btn btn-primary shadow-none me-xxl-3",cancelButton:"btn btn-danger shadow-none"},buttonsStyling:!1});localStorage.removeItem("fm_chatbot_thread"),jQuery("#flowmattic_chatbot_name").on("keyup",function(){var a=jQuery(this).val();jQuery(".flowmattic-chatbot-name h3").text(a)}),jQuery("#chatbot-setup, #form-styles, #form-actions").on("change",function(){jQuery(".fm-save-chatbot-settings").removeClass("disabled btn-outline-primary").addClass("btn-primary"),window.onbeforeunload=function(){return!0}}),jQuery("#chatbot_action_type").on("change",function(){var a=jQuery(this).val();"trigger_workflow"===a?(jQuery(".action-type-trigger_workflow").removeClass("d-none").addClass("d-block"),jQuery(".action-type-send_to_webhook").removeClass("d-block").addClass("d-none")):"send_to_webhook"===a&&(jQuery(".action-type-send_to_webhook").removeClass("d-none").addClass("d-block"),jQuery(".action-type-trigger_workflow").removeClass("d-block").addClass("d-none"))}),jQuery(".fm-save-chatbot-settings").on("click",function(){var a=(document.getElementById("chatbot-setup"),document.getElementById("form-styles"),{});jQuery(this).addClass("disabled").removeClass("btn-primary").addClass("btn-outline-primary"),a={chatbot_id:document.getElementById("chatbot_id").value,chatbot_name:document.getElementById("flowmattic_chatbot_name").value,chatbot_settings:{chatbot_name:document.getElementById("flowmattic_chatbot_name").value,chatbot_connect:document.getElementById("chatbot_model_connect").value,chatbot_assistant:document.getElementById("chatbot_assistant").value,chatbot_welcome_text:document.getElementById("chatbot_welcome_text").value,chatbot_user_placeholder:document.getElementById("chatbot_user_placeholder").value,chatbot_instructions:document.getElementById("chatbot_instructions").value,chatbot_default_reply:document.getElementById("chatbot_default_reply").value,load_user_chats:document.getElementById("load_user_chats").value,chatbot_model:document.getElementById("chatbot_model").value},chatbot_styles:{chatbot_page_background:document.getElementById("chatbot_page_background").value,chatbot_message_background:document.getElementById("chatbot_message_background").value,chatbot_user_message_background:document.getElementById("chatbot_user_message_background").value,loading_animation_type:document.getElementById("loading_animation_type").value,chatbox_icon:document.getElementById("chatbox_icon").value},chatbot_actions:{chatbot_action_event:document.getElementById("chatbot_action_event").value,chatbot_action_type:document.getElementById("chatbot_action_type").value,chatbot_action_workflow_id:document.getElementById("chatbot_action_workflow_id").value,chatbot_action_webhook_url:document.getElementById("chatbot_action_webhook_url").value},workflow_nonce:FMConfig.workflow_nonce,action:"flowmattic_chatbot_insert_or_update"},jQuery.ajax({url:ajaxurl,type:"POST",data:a,success:function(a){"success"===JSON.parse(a).status&&(g.fire({title:"Settings Saved!",text:"Your chatbot settings are successfully saved.",icon:"success",showConfirmButton:!0,timer:1500}),window.onbeforeunload=null)}})}),jQuery(".fm-reset-chatbot-settings").on("click",function(){var a={chatbot_page_background:"#f0f8ff",chatbot_message_background:"#0d6efd",user_message_background:"#fff",loading_animation_type:"spinner",chatbox_icon:jQuery("#chatbox_icon").attr("data-default")};jQuery("#chatbot_page_background").val(a.chatbot_page_background).trigger("change"),jQuery("#chatbot_message_background").val(a.chatbot_message_background).trigger("change"),jQuery("#chatbot_user_message_background").val(a.user_message_background).trigger("change"),jQuery("#chatbox_icon").val(a.chatbox_icon).trigger("change"),jQuery(".icon-preview img").attr("src",a.chatbox_icon),jQuery(".fm-save-chatbot-settings").removeClass("disabled btn-outline-primary").addClass("btn-primary"),window.onbeforeunload=function(){return!1}}),jQuery(".form-select").selectpicker(),jQuery(".color-control").wpColorPicker({change:function(a,c){var d=c.color.toString(),e=b(d);jQuery(this).val(d).trigger("change"),document.documentElement.style.setProperty("--"+jQuery(this).attr("id"),d),document.documentElement.style.setProperty("--"+jQuery(this).attr("id")+"_light",e)}}),jQuery(".btn-upload-icon").on("click",function(a){a.preventDefault();var b;b&&b.open(),b=wp.media({title:"Select Chat Icon",multiple:!1,library:{type:"image"}}),b.on("close",function(){var a=b.state().get("selection").first().toJSON();jQuery("#chatbox_icon").val(a.url).trigger("change"),jQuery(".icon-preview img").attr("src",a.url)}),b.on("open",function(){var a=b.state().get("selection"),c=jQuery("#chatbox_icon").val();c&&a.add(wp.media.attachment(c))}),b.open()}),document.querySelector(".refresh-assistants").addEventListener("click",function(){c()}),jQuery("#chatbot_model_connect").on("change",function(){c()}),jQuery("#chatbot_model_connect").val()&&c(jQuery("#chatbot_assistant").data("assistant-id"));var h=document.getElementById("create-assistant-btn"),i={};h.addEventListener("click",function(){var a=document.getElementById("assistant_name").value,b=document.getElementById("chatbot_connect").value,c=document.getElementById("assistant_model").value,d=document.getElementById("assistant_instructions").value,e=document.getElementById("assistant_description").value;return i={action:"flowmattic_chatbot_create_assistant",assistant_name:a,connect_id:b,assistant_model:c,assistant_instructions:d,assistant_description:e,workflow_nonce:FMConfig.workflow_nonce},b?a?c?(g.fire({title:"Creating Assistant...",showConfirmButton:!1,didOpen:function(){g.showLoading()}}),void jQuery.ajax({url:ajaxurl,type:"POST",data:i,success:function(a){var b=JSON.parse(a);"success"===b.status?(g.fire({title:"Assistant Creation Successful!",text:"Your new OpenAI Assistant is successfully created.",icon:"success",showConfirmButton:!0,timer:1500}),jQuery("#createAssistantModal").modal("hide"),jQuery("#chatbot_assistant").append('<option value="'+b.assistant_id+'" data-subtext="ID: '+b.assistant_id+'">'+b.assistant_name+"</option>"),jQuery("#chatbot_assistant").selectpicker("refresh"),jQuery("#chatbot_assistant").selectpicker("val",b.assistant_id)):g.fire({title:"Assistant Creation Failed!",text:"Your OpenAI Assistant creation is failed. Please try again later.",icon:"warning",showConfirmButton:!0,timer:1500})},error:function(a){g.fire({title:"Assistant Creation Failed!",text:"Your OpenAI Assistant creation is failed. Please try again later.",icon:"warning",showConfirmButton:!0,timer:1500})}})):void g.fire({title:"Assistant AI Model is required!",text:"Please choose an AI Model for your assistant.",icon:"warning",showConfirmButton:!0}):void g.fire({title:"Assistant Name is required!",text:"Please enter a name for your assistant.",icon:"warning",showConfirmButton:!0}):void g.fire({title:"Connect is required!",text:"Please choose a Connect to use with your assistant.",icon:"warning",showConfirmButton:!0})});var j=(document.querySelector(".flowmattic-chatbot-preview-wrapper"),document.querySelector(".flowmattic-chatbot-preview-body"),document.querySelector(".flowmattic-chatbot-messages"),!1),k='<div id="fm-ai-wave"><span class="fm-loading-dot"></span><span class="fm-loading-dot"></span><span class="fm-loading-dot"></span></div>',l='<svg class="spin-icon" xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18"><path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-155.5t86-127Q252-817 325-848.5T480-880q17 0 28.5 11.5T520-840q0 17-11.5 28.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160q133 0 226.5-93.5T800-480q0-17 11.5-28.5T840-520q17 0 28.5 11.5T880-480q0 82-31.5 155t-86 127.5q-54.5 54.5-127 86T480-80Z"/></svg>';jQuery(".nav-item .nav-link").on("click",function(){var a=jQuery(this).attr("aria-controls"),b=jQuery(".flowmattic-chatbot-message-holder");"wave"===document.getElementById("loading_animation_type").value&&(l=k),"conversations"===a?(j=!0,jQuery("#btn-restart-chatbot-preview").addClass("disabled"),jQuery("#flowmattic-chatbot-user-input").hide(),b.html(""),b.html(l),d(),jQuery(".conversation-item").first().find(".btn").click()):j&&(b.html(""),jQuery("#btn-restart-chatbot-preview").removeClass("disabled"),jQuery("#flowmattic-chatbot-user-input").show(),j=!1,jQuery(".jump-btn-container").removeClass("show"))}),jQuery(".conversation-wrapper").on("click",".conversation-item > .btn",function(){var a=jQuery(this).parent().attr("data-thread-id"),b=jQuery(".flowmattic-chatbot-message-holder"),c={action:"get_thread",settings:{chatbotID:document.getElementById("fm_chatbot_id").value,threadID:a},chatbot_nonce:FMConfig.chatbot_nonce,userId:document.getElementById("fm_user_id").value,secureKey:document.getElementById("fm_secure_key").value};"wave"===document.getElementById("loading_animation_type").value&&(l=k),jQuery(this).removeClass("btn-outline-secondary").addClass("btn-secondary"),jQuery(this).parent().siblings().find(".btn").removeClass("btn-secondary").addClass("btn-outline-secondary"),b.html(""),b.html(l),jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:c,success:function(a){var b=a.messages,c=a.chatbot;jQuery(".flowmattic-chatbot-message-holder").html("");for(var d=0;d<b.length;d++){var g=b[d],h=g.content[0].text.value,i="";"user"===g.role?(h=h.replace(/</g,"&lt;").replace(/>/g,"&gt;"),i='<div class="flowmattic-chatbot-message message-node-user"><div class="flowmattic-chatbot-message-content"><div class="flowmattic-chatbot-message-text">'+h+"</div></div></div>"):(h=f(h),i='<div class="flowmattic-chatbot-message message-node-ai responded"><div class="flowmattic-chatbot-message-content"><div class="flowmattic-chatbot-system-user">'+c+'</div><div class="flowmattic-chatbot-message-text">'+h+'</div></div><div class="copy-ai-response d-flex justify-content-end" title="Copy"><div class="click-to-copy"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-md"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C10.8954 4 10 4.89543 10 6H14C14 4.89543 13.1046 4 12 4ZM8.53513 4C9.22675 2.8044 10.5194 2 12 2C13.4806 2 14.7733 2.8044 15.4649 4H17C18.6569 4 20 5.34315 20 7V19C20 20.6569 18.6569 22 17 22H7C5.34315 22 4 20.6569 4 19V7C4 5.34315 5.34315 4 7 4H8.53513ZM8 6H7C6.44772 6 6 6.44772 6 7V19C6 19.5523 6.44772 20 7 20H17C17.5523 20 18 19.5523 18 19V7C18 6.44772 17.5523 6 17 6H16C16 7.10457 15.1046 8 14 8H10C8.89543 8 8 7.10457 8 6Z" fill="currentColor"></path></svg></div></div></div>'),e(i)}}})}),jQuery(".btn-copy-content").on("click",function(){var a=jQuery(this).prev(".fm-copy-content").text();navigator.clipboard.writeText(a),g.fire({title:"Copied!",text:"The content is copied to your clipboard.",icon:"success",showConfirmButton:!0,timer:1500})});var g=window.Swal.mixin({customClass:{confirmButton:"btn btn-primary shadow-none me-xxl-3",cancelButton:"btn btn-danger shadow-none"},buttonsStyling:!1}),m=document.getElementById("fileName"),n=document.querySelector(".btn-upload-file"),o=document.querySelector(".file-block"),p=document.querySelector(".upload-block"),q=document.querySelector(".btn-add-source"),r=document.getElementById("descriptionTextarea");n.addEventListener("click",function(){var a;return a&&a.open(),a=wp.media({title:"Select a file",button:{text:"Use this file"},multiple:!1}),a.on("select",function(){var b=a.state().get("selection").first().toJSON(),c=b.url;m.value=b.filename,p.classList.add("d-none"),o.classList.remove("d-none"),g.fire({title:"Uploading File!",text:"Please wait while we upload the file to OpenAI.",icon:"info",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1,didOpen:function(){g.showLoading()}});var d={action:"upload_content_source",settings:{chatbotID:document.getElementById("fm_chatbot_id").value,fileName:b.filename,fileType:b.mime,fileUrl:c},chatbot_nonce:FMConfig.chatbot_nonce,userId:document.getElementById("fm_user_id").value,secureKey:document.getElementById("fm_secure_key").value};jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:d,success:function(a){var b=a;"success"===b.status?(document.getElementById("openai_file_id").value=b.file_id,q.classList.remove("disabled"),g.fire({title:"File Uploaded!",text:"The file is successfully uploaded to OpenAI. Now, add it as content source.",icon:"success",showConfirmButton:!0,timer:1500})):g.fire({title:"Content Source Upload Failed!",text:"The content source upload is failed. Please try again later.",icon:"warning",showConfirmButton:!0,timer:1500})}})}),a.open(),!1}),q.addEventListener("click",function(){var a=document.getElementById("openai_file_id").value,b=r.value,c=document.getElementById("fileName").value;g.fire({title:"Adding Content Source!",text:"Please wait while we add the content source to your assistant. This can take up to a few minutes to complete.",icon:"info",showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,allowEnterKey:!1,didOpen:function(){g.showLoading()}});var d={action:"add_content_source",settings:{chatbotID:document.getElementById("fm_chatbot_id").value,openaiFileId:a,fileName:c,description:b},chatbot_nonce:FMConfig.chatbot_nonce,userId:document.getElementById("fm_user_id").value,secureKey:document.getElementById("fm_secure_key").value};jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:d,success:function(d){var e=d;if("success"===e.status){g.fire({title:"Content Source Added!",text:"The content source is successfully added.",icon:"success",showConfirmButton:!0,timer:1500}),jQuery("#addContentSourceModal").modal("hide"),document.getElementById("add_content_source_form").reset(),o.classList.add("d-none"),p.classList.remove("d-none");var f=document.querySelector(".content-sources"),h='<div class="content-source-item d-flex flex-row align-items-top justify-content-between p-2 border rounded gap-2">\t\t\t\t\t\t\t\t\t\t\t<div class="content-source-info d-flex flex-column gap-1">\t\t\t\t\t\t\t\t\t\t\t\t<div class="content-source-name d-flex flex-column gap-1">\t\t\t\t\t\t\t\t\t\t\t\t\t<span class="file-name fw-bold">'+c+'</span>\t\t\t\t\t\t\t\t\t\t\t\t\t<small class="file-id">FILE ID: '+a+'</small>\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t\t<div class="content-source-description">\t\t\t\t\t\t\t\t\t\t\t\t\t'+b+'\t\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t<div class="content-source-actions">\t\t\t\t\t\t\t\t\t\t\t\t<button type="button" class="btn btn-outline-danger btn-sm btn-delete-source" data-file-id="'+a+'">Delete</button>\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t</div>';f.innerHTML+=h}else g.fire({title:"Content Source Upload Failed!",text:"Message from OpenAI: "+e.message,icon:"warning",showConfirmButton:!0,timer:3e3})}})}),jQuery(".btn-delete-source").on("click",function(){var a=this;g.fire({title:"Are you sure?",text:"Once deleted, you will not be able to recover this content source! The file will be deleted from the OpenAI assistant only.",icon:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",showLoaderOnConfirm:!0}).then(function(b){if(b.isConfirmed){var c=a.getAttribute("data-file-id"),d={action:"delete_content_source",settings:{chatbotID:document.getElementById("fm_chatbot_id").value,sourceId:c},chatbot_nonce:FMConfig.chatbot_nonce,userId:document.getElementById("fm_user_id").value,secureKey:document.getElementById("fm_secure_key").value};jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:d,success:function(b){"success"===b.status?(g.fire({title:"Content Source Deleted!",text:"The content source is successfully deleted.",icon:"success",showConfirmButton:!0,timer:1500}),a.closest(".content-source-item").remove()):g.fire({title:"Content Source Deletion Failed!",text:"The content source deletion is failed. Please try again later.",icon:"warning",showConfirmButton:!0,timer:1500})}})}})})});