jQuery(document).ready(function(){"use strict";function a(a){var c=document.getElementById("fm_chatbot_id").value,d=document.getElementById("fm_chatbot_status").value,e=document.getElementById("fm_chatbot_name").value,f=document.getElementById("chatbot_input_field").value;if(f){document.getElementById("chatbot_input_field").value="",document.getElementById("chatbot_input_field").dispatchEvent(new Event("input")),document.getElementById("chatbot_input_field").disabled=!0,document.getElementById("chatbot_input_button").disabled=!0;var g=b.parseUserResponse(f);b.appendChatbotResponse(g);var h={chatbotName:e,chatbotMessage:b.getLoadingAnimation()},i=b.parseChatbotResponse(h);b.appendChatbotResponse(i),"preview"===d?b.createRun({chatbotID:c,chatbotName:e,message:f}):b.getThreadId({chatbotID:c,message:f}).then(function(a){setTimeout(function(){b.createMessage({threadID:a,chatbotID:c,chatbotName:e,message:f})},300)}),document.getElementById("chatbot_input_field").value=""}}var b={getSpinIcon:function(){return'<svg class="spin-icon" xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18"><path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-155.5t86-127Q252-817 325-848.5T480-880q17 0 28.5 11.5T520-840q0 17-11.5 28.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160q133 0 226.5-93.5T800-480q0-17 11.5-28.5T840-520q17 0 28.5 11.5T880-480q0 82-31.5 155t-86 127.5q-54.5 54.5-127 86T480-80Z"/></svg>'},getWaveLoader:function(){return'<div id="fm-ai-wave"><span class="fm-loading-dot"></span><span class="fm-loading-dot"></span><span class="fm-loading-dot"></span></div>'},getLoadingAnimation:function(){var a=document.getElementById("loading_animation_type").value,c=b.getSpinIcon();return"wave"===a&&(c=b.getWaveLoader()),c},getCopyIcon:function(){return'<div class="copy-ai-response d-flex justify-content-end" title="Copy"><div class="click-to-copy"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-md"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C10.8954 4 10 4.89543 10 6H14C14 4.89543 13.1046 4 12 4ZM8.53513 4C9.22675 2.8044 10.5194 2 12 2C13.4806 2 14.7733 2.8044 15.4649 4H17C18.6569 4 20 5.34315 20 7V19C20 20.6569 18.6569 22 17 22H7C5.34315 22 4 20.6569 4 19V7C4 5.34315 5.34315 4 7 4H8.53513ZM8 6H7C6.44772 6 6 6.44772 6 7V19C6 19.5523 6.44772 20 7 20H17C17.5523 20 18 19.5523 18 19V7C18 6.44772 17.5523 6 17 6H16C16 7.10457 15.1046 8 14 8H10C8.89543 8 8 7.10457 8 6Z" fill="currentColor"></path></svg></div></div>'},scrollToBottom:function(){var a=document.querySelector(".flowmattic-chatbot-message-holder"),b=document.querySelector(".flowmattic-chatbot-messages");a.scrollTop=a.scrollHeight,b.scrollTo({top:b.scrollHeight+100})},getChatbot:function(a){var b={action:"flowmattic_chatbot_method_get_chatbot",settings:a,chatbot_nonce:FMConfig.chatbot_nonce,action:"get_chatbot"};return new Promise(function(a){jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:b,success:function(b){a(b)}})})},createThread:function(a){var b={action:"create_thread",settings:a,chatbot_nonce:FMConfig.chatbot_nonce};jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:b,success:function(a){var b=a;"success"===b.status&&localStorage.setItem("fm_chatbot_thread",b.thread_id)}})},getThreadId:function(a){return new Promise(function(c,d){var e=localStorage.getItem("fm_chatbot_thread");if(e)c(e);else{var f={action:"create_thread",settings:a,chatbot_nonce:FMConfig.chatbot_nonce};jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:f,success:function(a){var b=a;"success"===b.status?(localStorage.setItem("fm_chatbot_thread",b.thread_id),c(b.thread_id)):d(b.message)},error:function(a){if("rest_cookie_invalid_nonce"===a.responseJSON.code){var c={chatbotName:"System:",chatbotMessage:'<strong style="color: #a52a2a;">User Session Cookie Expired!</strong><br/><p>Please try clearing your browser cookies and reload the page.</p>'},e=b.parseChatbotResponse(c);b.appendChatbotResponse(e)}d(a)}})}})},createMessage:function(a){var c={action:"create_message",settings:a,chatbot_nonce:FMConfig.chatbot_nonce};jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:c,success:function(a){var c=a;if("success"===c.status){var d=c.content;d=b.formatContent(d),b.typeMessage(d,document.querySelector(".flowmattic-chatbot-message-holder .message-node-ai:last-child .flowmattic-chatbot-message-text"))}else{b.typeMessage('<strong style="color: #a52a2a;">Error retrieving response. Please try refreshing the page after a few seconds.</strong>',document.querySelector(".flowmattic-chatbot-message-holder .message-node-ai:last-child .flowmattic-chatbot-message-text"))}}})},createRun:function(a){var c={settings:a,chatbot_nonce:FMConfig.chatbot_nonce,action:"create_run"},d=localStorage.getItem("fm_chatbot_thread");c.settings.threadID=d||"",jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:c,success:function(a){var c=a;if("success"===c.status){var d=c.content;d=b.formatContent(d),b.typeMessage(d,document.querySelector(".flowmattic-chatbot-message-holder .message-node-ai:last-child .flowmattic-chatbot-message-text")),localStorage.setItem("fm_chatbot_thread",c.thread_id)}}})},retrieveRun:function(a){var b={action:"flowmattic_chatbot_method_retrieve_run",settings:a,chatbot_nonce:FMConfig.chatbot_nonce};jQuery.post(ajaxurl,b,function(a){})},retrieveMessages:function(a){var c=jQuery(".flowmattic-chatbot-message-holder"),e={action:"get_thread",settings:{chatbotID:document.getElementById("fm_chatbot_id").value,threadID:d},chatbot_nonce:FMConfig.chatbot_nonce};c.html(""),c.html(b.getLoadingAnimation()),jQuery.ajax({url:FMConfig.chatbotAjax,type:"POST",data:e,success:function(a){var c=a.messages,d=a.chatbot;jQuery(".flowmattic-chatbot-message-holder").html("");for(var e=0;e<c.length;e++){var f=c[e],g=f.content[0].text.value,h="";if("user"===f.role)g=g.replace(/</g,"&lt;").replace(/>/g,"&gt;"),h=b.parseUserResponse(g);else{g=b.formatContent(g);var i={chatbotName:d,chatbotMessage:g};h=b.parseChatbotResponse(i),h=h.replace("message-node-ai","message-node-ai responded")}b.appendChatbotResponse(h)}}})},parseUserResponse:function(a){return a=a.replace(/</g,"&lt;").replace(/>/g,"&gt;"),'<div class="flowmattic-chatbot-message message-node-user"><div class="flowmattic-chatbot-message-content"><div class="flowmattic-chatbot-message-text">{{userMessage}}</div></div></div>'.replace("{{userMessage}}",a)},parseChatbotResponse:function(a){var c="";return c='<div class="flowmattic-chatbot-message message-node-ai"><div class="flowmattic-chatbot-message-content"><div class="flowmattic-chatbot-system-user">{{chatbotName}}</div><div class="flowmattic-chatbot-message-text pre-line">{{chatbotMessage}}</div></div>{{copyIcon}}</div>'.replace("{{chatbotName}}",a.chatbotName),c=c.replace("{{chatbotMessage}}",a.chatbotMessage),c=c.replace("{{copyIcon}}",b.getCopyIcon())},appendChatbotResponse:function(a){var c=jQuery(".flowmattic-chatbot-message-holder").outerHeight(),d=jQuery(".flowmattic-chatbot-messages").outerHeight();jQuery(".flowmattic-chatbot-message-holder").append(a),c>d&&(jQuery(".flowmattic-chatbot-message-holder").addClass("scrollable"),b.scrollToBottom())},formatContent:function(a){return a=a.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),a.split("\n").filter(function(a){return a.trim()}).map(function(a,b,c){return a.trim().startsWith("<!-")?"&lt;"+a.trim().substring(1):a.trim().startsWith("<script")||a.trim().startsWith("<meta")||a.trim().startsWith("<title")||a.trim().startsWith("<link")?"<p>&lt;"+a.trim().substring(1)+"</p>"+(b<c.length-1?"\n":""):a.trim().startsWith("<")?a:"<p>"+a+"</p>"+(b<c.length-1?"\n":"")}).join("")},typeMessage:function(a,c){function d(){if(e<g){i=a.slice(0,++e),c.innerHTML=i,b.scrollToBottom();var j=i.slice(-1);if("<"===j&&(h=!0),">"===j&&(h=!1),h)return void d();setTimeout(function(){d()},f)}else document.getElementById("chatbot_input_field").disabled=!1,document.getElementById("chatbot_input_button").disabled=!1,document.getElementById("chatbot_input_field").focus(),document.querySelector(".flowmattic-chatbot-message-holder .message-node-ai:last-child").classList.add("responded")}var e=0,f=2,g=a.length,h=!1,i="";c.innerHTML="",d()}};document.getElementById("chatbot_input_field").addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"});var c=document.getElementById("flowmattic-chatbot-user-input");c.addEventListener("keypress",function(b){"Enter"===(b.key||b.code)&&(a(b),b.preventDefault())}),c.addEventListener("submit",function(b){b.preventDefault(),a(b)}),document.getElementById("chatbot_input_button").addEventListener("click",function(b){b.preventDefault(),a(b)});var d=localStorage.getItem("fm_chatbot_thread"),e=document.getElementById("load_user_chats").value;if(d&&"yes"===e){var f=document.getElementById("fm_chatbot_id").value,g=document.getElementById("fm_chatbot_status").value,h=document.getElementById("fm_chatbot_name").value;"live"===g&&b.retrieveMessages({chatbotID:f,threadID:d,chatbotName:h})}var i=document.getElementById("btn-restart-chatbot-preview");i&&i.addEventListener("click",function(a){a.preventDefault(),localStorage.removeItem("fm_chatbot_thread"),jQuery(".flowmattic-chatbot-message-holder").slideUp(250,function(){jQuery(this).html("").slideDown(250)})}),jQuery(".flowmattic-chatbot-messages").on("scroll",function(){var a=jQuery(".flowmattic-chatbot-message-holder");a.offset().top+a.outerHeight()-50<=jQuery(window).height()+jQuery(window).scrollTop()?jQuery(".jump-btn-container").removeClass("show"):jQuery(".jump-btn-container").addClass("show")}),jQuery(".jump-to-latest").on("click",function(){var a=document.querySelector(".flowmattic-chatbot-message-holder"),b=document.querySelector(".flowmattic-chatbot-messages");a.scrollTop=a.scrollHeight,b.scrollTo({top:b.scrollHeight+100,behavior:"smooth"})}),jQuery(document).on("click",".click-to-copy",function(){var a=jQuery(this),b=a.html(),c=jQuery(this).closest(".flowmattic-chatbot-message").find(".flowmattic-chatbot-message-text").text();navigator.clipboard.writeText(c),a.html('<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon-md"><path fill-rule="evenodd" clip-rule="evenodd" d="M18.0633 5.67375C18.5196 5.98487 18.6374 6.607 18.3262 7.06331L10.8262 18.0633C10.6585 18.3093 10.3898 18.4678 10.0934 18.4956C9.79688 18.5234 9.50345 18.4176 9.29289 18.2071L4.79289 13.7071C4.40237 13.3166 4.40237 12.6834 4.79289 12.2929C5.18342 11.9023 5.81658 11.9023 6.20711 12.2929L9.85368 15.9394L16.6738 5.93664C16.9849 5.48033 17.607 5.36263 18.0633 5.67375Z" fill="currentColor"></path></svg>'),setTimeout(function(){a.html(b)},2e3)})});